---
groups:
- name: main
  jobs:
{%- for job in jobs %}
  - {{ job.name }}
{%- endfor %}

{%- if sonar %}
resource_types:
- name: sonar-runner
  type: docker-image
  source:
    repository: cathive/concourse-sonarqube-resource
    tag: 0.6.0
{%- endif %}

resources:
- name: source-deploy
  type: git
  source:
    uri:  {{ git_deploy_prefix }}/{{ git_deploy_repo }}
    branch: master
    private_key: {{ '{{' }}git-private-key{{ '}}' }}
{%- if sonar %}
- name: code-analysis
  type: sonar-runner
  source:
    host_url: {{ sonar }}
    login: admin
    password: admin
{%- endif %}
{%- for repo in micros_list %}
- name: {{ repo }}
  type: git
  source:
    uri:  {{ git_prefix }}/{{ repo }}
    branch: {{ git_branch }}
    private_key: {{ '{{' }}git-private-key{{ '}}' }}
{%- endfor %}

jobs:
{%- for job in jobs %}
- name: {{ job.name }}
  public: true
  serial: true
  plan:
  - get: source-deploy
  {%- for repo in micros_list %}
  - get: {{ repo }}
    {%- if job.passed %}
    passed: [{{ job.passed }}]
    {%- endif %}
    trigger: true
  {%- endfor %}
  {%- for task in job.tasks %}
{{ task }}
    params:
      CF_API: {{ '{{' }}cf-api{{ '}}' }}
      CF_USER: {{ '{{' }}cf-username{{ '}}' }}
      CF_PASSWORD: {{ '{{' }}cf-password{{ '}}' }}
      CF_SSOCODE: {{ '{{' }}cf-ssocode{{ '}}' }}
      CF_ORG: {{ '{{' }}cf-organization{{ '}}' }}
      CF_SPACE: {{ '{{' }}cf-space{{ '}}' }}
      CF_BUILDPACK: {{ cf_buildpack }}
      MICROSLIST: {{ micros_list_str }}
  {%- endfor %}
{%- endfor %}